<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>シューティングゲーム（スコア400クリア）</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background-color: #000;
      font-family: sans-serif;
      color: white;
    }
    canvas {
      display: block;
      background-color: #111;
    }
    #backButton, #scoreDisplay, #timerDisplay {
      position: absolute;
      padding: 10px 20px;
      background-color: #fff;
      color: #000;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      z-index: 10;
      user-select: none;
    }
    #backButton {
      top: 20px;
      left: 20px;
      cursor: pointer;
    }
    #scoreDisplay {
      top: 20px;
      right: 120px;
    }
    #timerDisplay {
      top: 20px;
      right: 20px;
    }
    #gameMessage {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 36px;
      background: rgba(0,0,0,0.8);
      padding: 20px 40px;
      border-radius: 10px;
      display: none;
      z-index: 10;
      text-align: center;
      white-space: pre-line;
    }
  </style>
</head>
<body>

<button id="backButton" onclick="location.href='index.html'">戻る</button>
<div id="scoreDisplay">スコア: 0</div>
<div id="timerDisplay">時間: 30</div>
<div id="gameMessage"></div>
<canvas id="gameCanvas"></canvas>

<audio id="bgm" src="https://cdn.pixabay.com/download/audio/2021/11/09/audio_f257713204.mp3?filename=8-bit-loop-13742.mp3" loop></audio>
<audio id="shotSound" src="https://cdn.pixabay.com/download/audio/2022/03/23/audio_0317a08470.mp3?filename=laser-gun-6299.mp3"></audio>
<audio id="hitSound" src="https://cdn.pixabay.com/download/audio/2022/03/20/audio_dbc0f39bda.mp3?filename=pop-6264.mp3"></audio>
<audio id="gameOverSound" src="https://cdn.pixabay.com/download/audio/2022/03/27/audio_f497fb186f.mp3?filename=game-over-arcade-6435.mp3"></audio>

<script>
  const canvas = document.getElementById("gameCanvas");
  const ctx = canvas.getContext("2d");
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;

  const bgm = document.getElementById("bgm");
  const shotSound = document.getElementById("shotSound");
  const hitSound = document.getElementById("hitSound");
  const gameOverSound = document.getElementById("gameOverSound");

  const player = {
    x: canvas.width / 2,
    y: canvas.height - 60,
    width: 40,
    height: 40,
    color: "lime",
    speed: 10
  };

  const bullets = [];
  const enemies = [];
  let score = 0;
  let timeLeft = 30; // 制限時間30秒
  let gameOver = false;
  let scoreGoal = 400;  // クリアに必要なスコアを400に変更

  function createEnemy() {
    const type = Math.random() < 0.7 ? "red" : "blue";
    const enemy = {
      x: Math.random() * (canvas.width - 40),
      y: -40,
      width: 40,
      height: 40,
      hp: type === "red" ? 1 : 3,
      speed: type === "red" ? 2 : 3,
      color: type === "red" ? "red" : "blue"
    };
    enemies.push(enemy);
  }

  function drawPlayer() {
    ctx.fillStyle = player.color;
    ctx.fillRect(player.x, player.y, player.width, player.height);
  }

  function drawBullets() {
    for (let i = bullets.length - 1; i >= 0; i--) {
      const b = bullets[i];
      b.y -= 10;
      ctx.fillStyle = "yellow";
      ctx.fillRect(b.x, b.y, 5, 20);
      if (b.y < 0) bullets.splice(i, 1);
    }
  }

  function drawEnemies() {
    for (let i = enemies.length - 1; i >= 0; i--) {
      const e = enemies[i];
      e.y += e.speed;
      ctx.fillStyle = e.color;
      ctx.fillRect(e.x, e.y, e.width, e.height);

      if (e.y > canvas.height) {
        enemies.splice(i, 1);
      }
    }
  }

  function checkCollision() {
    // 弾と敵の当たり判定
    for (let ei = enemies.length -1; ei >= 0; ei--) {
      const e = enemies[ei];
      for (let bi = bullets.length -1; bi >= 0; bi--) {
        const b = bullets[bi];
        if (
          b.x < e.x + e.width &&
          b.x + 5 > e.x &&
          b.y < e.y + e.height &&
          b.y + 20 > e.y
        ) {
          e.hp--;
          bullets.splice(bi, 1);
          if (e.hp <= 0) {
            enemies.splice(ei, 1);
            score += e.color === "red" ? 10 : 30;
            updateScore();
            hitSound.currentTime = 0;
            hitSound.play();
          }
          break;
        }
      }
    }

    // プレイヤーと敵の当たり判定（即ゲームオーバー）
    for (let e of enemies) {
      if (
        player.x < e.x + e.width &&
        player.x + player.width > e.x &&
        player.y < e.y + e.height &&
        player.y + player.height > e.y
      ) {
        endGame(false);
      }
    }
  }

  function updateScore() {
    document.getElementById("scoreDisplay").textContent = `スコア: ${score}`;
  }
  function updateTimer() {
    document.getElementById("timerDisplay").textContent = `時間: ${timeLeft}`;
  }

  function endGame(won) {
    if (gameOver) return;
    gameOver = true;
    bgm.pause();
    if (!won) {
      gameOverSound.currentTime = 0;
      gameOverSound.play();
    }
    const msg = document.getElementById("gameMessage");
    msg.style.display = "block";
    msg.textContent = won 
      ? `ゲームクリア！\nスコア: ${score}`
      : `ゲームオーバー！\nスコア: ${score}`;
  }

  function gameLoop() {
    if (gameOver) return;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    drawPlayer();
    drawBullets();
    drawEnemies();
    checkCollision();

    if (timeLeft <= 0) {
      if (score >= scoreGoal) {
        endGame(true);
      } else {
        endGame(false);
      }
      return;
    }

    requestAnimationFrame(gameLoop);
  }

  function spawnEnemies() {
    if (!gameOver) {
      for (let i = 0; i < 5; i++) {
        createEnemy();
      }
    }
  }

  document.addEventListener("keydown", e => {
    if (gameOver) return;
    if (e.key === "ArrowLeft" && player.x > 0) player.x -= player.speed;
    if (e.key === "ArrowRight" && player.x < canvas.width - player.width) player.x += player.speed;
    if (e.key === " ") {
      bullets.push({ x: player.x + player.width / 2 - 2.5, y: player.y });
      shotSound.currentTime = 0;
      shotSound.play();
    }
  });

  setInterval(() => {
    if (!gameOver) {
      timeLeft--;
      updateTimer();
      if (timeLeft <= 0) gameLoop();
    }
  }, 1000);

  setInterval(spawnEnemies, 1500);

  updateScore();
  updateTimer();

  bgm.volume = 0.3;
  bgm.play().catch(() => {});

  gameLoop();
</script>
</body>
</html>
